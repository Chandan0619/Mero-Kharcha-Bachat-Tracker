{% extends 'finance/base.html' %}
{% load humanize %}

{% block content %}
<style>
    .stat-subtext {
        font-size: 0.8rem;
        color: #6b7280;
        margin-top: 4px;
        font-weight: 500;
    }

    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
        margin-bottom: 32px;
    }

    .stat-card {
        padding: 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    .stat-info {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .stat-label {
        font-size: 1rem;
        font-weight: 500;
        color: var(--text-main);
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: black;
    }

    .stat-value-e {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--danger);
    }

    .stat-value-i {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--success);
    }

    .stat-trend {
        font-size: 0.85rem;
        display: flex;
        align-items: center;
        gap: 4px;
        color: var(--success);
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .icon-blue {
        background-color: #dbeafe;
        color: #3b82f6;
    }

    .icon-green {
        background-color: #dcfce7;
        color: #22c55e;
    }

    .icon-red {
        background-color: #fee2e2;
        color: #ef4444;
    }

    .icon-purple {
        background-color: #f3e8ff;
        color: #8b5cf6;
    }

    .chart-container {
        padding: 24px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        margin-bottom: 32px;
    }

    .chart-header {
        margin-bottom: 24px;
        font-size: 1.25rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .transaction-container {
        padding: 24px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        margin-top: 32px;
    }

    .text-success {
        color: #10b981;
    }

    .text-danger {
        color: #ef4444;
    }

    .amount-cell {
        font-weight: 700;
        white-space: nowrap;
    }

    .type-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .badge-income {
        background: #dcfce7;
        color: #166534;
    }

    .badge-expense {
        background: #fee2e2;
        color: #991b1b;
    }

    .more-link-container {
        display: flex;
        justify-content: flex-end;
        padding-top: 16px;
        border-top: 1px solid #f3f4f6;
        margin-top: 16px;
    }

    .more-link {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.95rem;
        transition: transform 0.2s;
    }

    .more-link:hover {
        transform: translateX(4px);
    }

    /* Reminders Section Style */
    .reminders-section {
        margin-top: 32px;
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    }

    .reminder-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 16px;
    }

    .reminder-card {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        background: #f9fafb;
        border-radius: 10px;
        border-left: 4px solid #6366f1;
        text-decoration: none;
        color: inherit;
        transition: transform 0.2s, background-color 0.2s;
    }

    .reminder-card:hover {
        transform: translateY(-2px);
        background-color: #f3f4f6;
    }

    .reminder-btn-done {
        background-color: #dcfce7;
        color: #166534;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        font-size: 0.85rem;
        transition: background-color 0.2s;
    }

    .reminder-btn-done:hover {
        background-color: #bbf7d0;
    }

    .secondary-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-top: 32px;
    }

    @media (max-width: 992px) {

        .secondary-grid,
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
    }

    .pocket-badge {
        font-size: 0.7rem;
        padding: 2px 8px;
        border-radius: 4px;
        background: #f3f4f6;
        color: #4b5563;
        margin-top: 4px;
        display: inline-block;
    }
</style>

<div class="dashboard-grid">
    <!-- Total Income -->
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-label">Total Income</span>
            <span class="stat-value-i">Rs. {{ income_total|floatformat:0|intcomma }}</span>
        </div>
        <div class="stat-icon icon-green">
            <i class="fa-solid fa-hand-holding-dollar"></i>
        </div>
    </div>
    <!-- Total Expense -->
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-label">Total Expense</span>
            <span class="stat-value-e">Rs. {{ expense_total|floatformat:0|intcomma }}</span>
        </div>
        <div class="stat-icon icon-red">
            <i class="fa-solid fa-money-bill-trend-up"></i>
        </div>
    </div>
    <!-- Net Savings (Total Surplus) -->
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-label">Total Surplus</span>
            <span class="stat-value {% if savings >= 0 %}text-success{% else %}text-danger{% endif %}">
                Rs. {{ savings|floatformat:0|intcomma }}
            </span>
            <div class="stat-subtext">Cash: Rs. {{ unallocated_savings|floatformat:0|intcomma }}</div>
        </div>
        <div class="stat-icon icon-blue">
            <i class="fa-solid fa-wallet"></i>
        </div>
    </div>
    <!-- Accumulated Savings (Automated) -->
    <div class="stat-card">
        <div class="stat-info">
            <span class="stat-label">Auto Savings</span>
            <span class="stat-value" style="color: #8b5cf6;">Rs. {{ automated_savings|floatformat:0|intcomma }}</span>
            <div class="stat-subtext">20% rule active</div>
        </div>
        <div class="stat-icon icon-purple">
            <i class="fa-solid fa-vault"></i>
        </div>
    </div>
</div>

<div class="chart-container">
    <div class="chart-header">
        <i class="fa-solid fa-chart-column" style="color: var(--accent-blue);"></i> Daily Comparison (Income vs Expense)
    </div>
    <div style="height: 300px; position: relative;">
        <canvas id="financeChart"></canvas>
    </div>
</div>

<div class="secondary-grid">
    <!-- Active Pockets / Budgets -->
    <div class="transaction-container" style="margin-top: 0;">
        <div class="chart-header"><i class="fa-solid fa-piggy-bank" style="color: #eab308;"></i> Active Pockets</div>
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Category</th>
                    <th style="text-align: right;">Spent</th>
                    <th style="text-align: right;">Left</th>
                </tr>
            </thead>
            <tbody>
                {% for b in budgets %}
                <tr>
                    <td>
                        <div style="font-weight: 600;">{{ b.category }}</div>
                        <span class="pocket-badge">{{ b.period }}</span>
                    </td>
                    <td style="text-align: right; color: #ef4444;">Rs. {{ b.spent|floatformat:0|intcomma }}</td>
                    <td
                        style="text-align: right; font-weight: 700; color: {% if b.remaining < 0 %}#ef4444{% else %}#10b981{% endif %};">
                        Rs. {{ b.remaining|floatformat:0|intcomma }}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align: center; color: var(--text-muted); padding: 20px;">No active
                        pockets set.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Savings Goals -->
    <div class="transaction-container" style="margin-top: 0;">
        <div class="chart-header"><i class="fa-solid fa-bullseye" style="color: #ec4899;"></i> Savings Goals</div>
        <table style="width: 100%;">
            <thead>
                <tr>
                    <th>Goal</th>
                    <th style="text-align: right;">Target</th>
                    <th style="text-align: right;">Current</th>
                </tr>
            </thead>
            <tbody>
                {% for goal in savings_goals %}
                <tr>
                    <td style="font-weight: 600;">{{ goal.name }}</td>
                    <td style="text-align: right;">Rs. {{ goal.target_amount|floatformat:0|intcomma }}</td>
                    <td style="text-align: right; color: #10b981; font-weight: 700;">Rs. {{
                        goal.current_amount|floatformat:0|intcomma }}</td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align: center; color: var(--text-muted); padding: 20px;">No savings
                        goals set.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="transaction-container">
    <div class="chart-header"><i class="fa-solid fa-list-ul" style="color: #6366f1;"></i> Recent Transactions</div>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Details</th>
                <th>Type</th>
                <th style="text-align: right;">Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for tx in recent_transactions %}
            <tr>
                <td>{{ tx.date|date:"M d" }}</td>
                <td style="font-weight: 500;">
                    {% if tx.transaction_type == 'Income' %}
                    {{ tx.source }}
                    {% else %}
                    {{ tx.category }}
                    {% endif %}
                </td>
                <td>
                    <span class="type-badge badge-{{ tx.transaction_type|lower }}">
                        {{ tx.transaction_type }}
                    </span>
                </td>
                <td style="text-align: right;"
                    class="amount-cell {% if tx.transaction_type == 'Income' %}text-success{% else %}text-danger{% endif %}">
                    Rs. {{ tx.amount|floatformat:0|intcomma }}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" style="text-align: center; color: var(--text-muted); padding: 20px;">No recent
                    transactions</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="more-link-container">
        <a href="{% url 'all_transactions' %}" class="more-link">
            View All History <i class="fa-solid fa-arrow-right"></i>
        </a>
    </div>
</div>

<!-- Reminders Section -->
<div class="reminders-section">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 class="chart-header" style="margin-bottom: 0;"><i class="fa-solid fa-bell" style="color: #6366f1;"></i>
            Planned Reminders</h3>
        <a href="{% url 'add_reminder' %}" class="more-link">View All <i class="fa-solid fa-chevron-right"></i></a>
    </div>

    <div class="reminder-list">
        {% for reminder in reminders %}
        <div style="display: flex; gap: 12px; align-items: center;">
            <a href="{% url 'add_reminder' %}" class="reminder-card" style="flex: 1;">
                <div>
                    <div style="font-weight: 600;">{{ reminder.title }}</div>
                    <div style="font-size: 0.85rem; color: var(--text-muted);">
                        <i class="fa-solid fa-calendar-day"></i> {{ reminder.reminder_date|date:"M d, Y" }}
                        <span style="margin: 0 8px;">|</span>
                        <i class="fa-solid fa-clock"></i> {{ reminder.reminder_date|date:"h:i A" }}
                    </div>
                </div>
            </a>
            <a href="{% url 'complete_reminder' reminder.pk %}" class="reminder-btn-done">
                <i class="fa-solid fa-check"></i>
            </a>
        </div>
        {% empty %}
        <p style="text-align: center; color: var(--text-muted); padding: 20px;">No pending reminders.</p>
        {% endfor %}
    </div>
</div>

<!-- Data for Chart.js -->
{{ chart_dates|json_script:"chart-dates-data" }}
{{ expense_chart_data|json_script:"chart-expense-data" }}
{{ income_chart_data|json_script:"chart-income-data" }}

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const canvas = document.getElementById('financeChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        // Safely parse JSON data from script tags
        let chartLabels = [];
        let expenseValues = [];
        let incomeValues = [];
        try {
            chartLabels = JSON.parse(document.getElementById('chart-dates-data').textContent);
            expenseValues = JSON.parse(document.getElementById('chart-expense-data').textContent);
            incomeValues = JSON.parse(document.getElementById('chart-income-data').textContent);
        } catch (e) {
            console.error("Error parsing chart data:", e);
        }

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: chartLabels,
                datasets: [
                    {
                        label: 'Income',
                        data: incomeValues,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: '#10b981',
                        borderWidth: 2,
                        borderRadius: 6,
                        barPercentage: 0.8,
                        categoryPercentage: 0.6
                    },
                    {
                        label: 'Expenses',
                        data: expenseValues,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: '#ef4444',
                        borderWidth: 2,
                        borderRadius: 6,
                        barPercentage: 0.8,
                        categoryPercentage: 0.6
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 20,
                            font: { size: 12, weight: '500' }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(17, 24, 39, 0.9)',
                        padding: 12,
                        cornerRadius: 8,
                        intersect: false,
                        mode: 'index',
                        callbacks: {
                            label: function (context) {
                                return ' ' + context.dataset.label + ': Rs. ' + (context.raw || 0).toLocaleString();
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#f3f4f6', drawBorder: false },
                        ticks: {
                            color: '#6b7280',
                            callback: function (value) { return 'Rs. ' + value.toLocaleString(); }
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#6b7280' }
                    }
                }
            }
        });
    });
</script>
{% endblock %}